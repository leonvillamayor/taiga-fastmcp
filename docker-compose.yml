# Docker Compose for Taiga MCP Server
# Version: 0.1.1
# Supports HTTP transport for MCP protocol with integrated caching
#
# Usage:
#   Development:  docker compose --profile dev up
#   Production:   docker compose --profile prod up -d
#   Default:      docker compose up
#
# Configuration: Copy .env.example to .env and configure your credentials
#
# Cache Configuration (v0.1.1):
#   TAIGA_CACHE_ENABLED: Enable/disable caching (default: true)
#   TAIGA_CACHE_TTL: Cache time-to-live in seconds (default: 3600)
#   TAIGA_CACHE_MAX_SIZE: Maximum cache entries (default: 1000)

services:
  # =============================================================================
  # Base MCP Server Service (used as template, never runs directly)
  # =============================================================================
  taiga-mcp-server-base:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: taiga-mcp-server:latest
    profiles:
      - donotstart

    # Load environment from .env file
    env_file:
      - .env

    # Override transport settings for Docker
    environment:
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # Cache configuration (v0.1.1)
      - TAIGA_CACHE_ENABLED=${TAIGA_CACHE_ENABLED:-true}
      - TAIGA_CACHE_TTL=${TAIGA_CACHE_TTL:-3600}
      - TAIGA_CACHE_MAX_SIZE=${TAIGA_CACHE_MAX_SIZE:-1000}

    # Port mapping for HTTP transport
    ports:
      - "${MCP_PORT:-8000}:8000"

    # Restart policy
    restart: unless-stopped

    # Health check configuration
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; req = urllib.request.Request('http://localhost:8000/mcp', headers={'Accept': 'application/json, text/event-stream'}, method='POST'); urllib.request.urlopen(req, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels
    labels:
      - "com.taiga.mcp.description=Taiga MCP Server with cache integration"
      - "com.taiga.mcp.version=0.1.1"
      - "com.taiga.mcp.transport=http"
      - "com.taiga.mcp.cache=enabled"

    # Network
    networks:
      - taiga-mcp-network

  # =============================================================================
  # Default Service (docker compose up)
  # =============================================================================
  taiga-mcp-server:
    extends:
      service: taiga-mcp-server-base
    container_name: taiga-mcp-server
    profiles:
      - default

  # =============================================================================
  # Production Profile
  # =============================================================================
  taiga-mcp-server-prod:
    extends:
      service: taiga-mcp-server-base
    container_name: taiga-mcp-server-prod
    profiles:
      - prod

    env_file:
      - .env

    environment:
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - MCP_DEBUG=false
      - TAIGA_TIMEOUT=60
      - TAIGA_MAX_RETRIES=5
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # Production cache settings (v0.1.1) - optimized for performance
      - TAIGA_CACHE_ENABLED=true
      - TAIGA_CACHE_TTL=7200
      - TAIGA_CACHE_MAX_SIZE=5000

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # =============================================================================
  # Development Profile
  # =============================================================================
  taiga-mcp-server-dev:
    extends:
      service: taiga-mcp-server-base
    container_name: taiga-mcp-server-dev
    profiles:
      - dev

    env_file:
      - .env

    environment:
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - MCP_DEBUG=true
      - PYTHONUNBUFFERED=1
      # Development cache settings (v0.1.1) - shorter TTL for faster iteration
      - TAIGA_CACHE_ENABLED=true
      - TAIGA_CACHE_TTL=300
      - TAIGA_CACHE_MAX_SIZE=100

    # Mount source for development
    volumes:
      - ./src:/app/src:ro
      - ./logs:/app/logs

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

# =============================================================================
# Networks
# =============================================================================
networks:
  taiga-mcp-network:
    driver: bridge
    name: taiga-mcp-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mcp-logs:
    driver: local
    name: taiga-mcp-logs
